import streamlit as st
import pdfplumber
import re
import smtplib
import pandas as pd
import matplotlib.pyplot as plt
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# ==========================================
# ‚öôÔ∏è KONFIGURACJA I BAZA WIEDZY
# ==========================================
PROG_KWOTOWY = 1000.00
NAGRODA_ZA_PROG = "Bluza Polarowa (za 1 z≈Ç)"
LIMIT_INTERWENCJI = 300.00
MOJ_NIP = "7722420459"

# --- ROZSZERZONY M√ìZG (Wszystkie gazetki) ---
INTELIGENTNE_REGULY = {
    # Zima / Sezon
    "Prowadnica": {"produkt": "Ostrza≈Çka (G81207)", "cena": 79.29, "opis": "Serwis pi≈Ç - towar powiƒÖzany"},
    "≈Åa≈Ñcuch": {"produkt": "Olej do ≈Ça≈Ñcuch√≥w (G82000)", "cena": 19.99, "opis": "Eksploatacja pi≈Ç"},
    "≈öniegow": {"produkt": "Prostownik z rozruchem", "cena": 250.00, "opis": "Zima - problemy z akumulatorami"},
    
    # Gazetka 2026AB (Wielosztuki)
    "Nagrzewnica": {"produkt": "Druga sztuka (Rabat!)", "cena": 164.76, "opis": "Wielosztuki: Taniej przy 2 szt. (G80402)"},
    "WciƒÖgarka": {"produkt": "Uchwyt / Zblocze", "cena": 40.00, "opis": "WciƒÖgarki (G01097) sƒÖ w promocji wielosztukowej!"},
    "Podno≈õnik": {"produkt": "Koby≈Çki warsztatowe 3T", "cena": 55.00, "opis": "BHP: Podno≈õnik zawsze z koby≈Çkami"},
    "Grzejnik": {"produkt": "Druga sztuka (Konwektor)", "cena": 76.82, "opis": "Promocja 2026AB: Grzejniki G80443 taniej w parach"},
    
    # Narzƒôdzia Tvardy / Geko
    "Siekiera": {"produkt": "Ostrza≈Çka 2w1 (T02-009)", "cena": 15.00, "opis": "Idealny dodatek do siekier"},
    "Wykrƒôtak": {"produkt": "Gwintowniki (G38301)", "cena": 50.89, "opis": "Naprawa gwint√≥w po awarii"},
    "Spawark": {"produkt": "Przy≈Çbica samo≈õciemniajƒÖca", "cena": 45.00, "opis": "Niezbƒôdne BHP przy spawaniu"},
    "Pistolet": {"produkt": "WƒÖ≈º pneumatyczny", "cena": 30.00, "opis": "Akcesoria do pneumatyki"},
    "Rega≈Ç": {"produkt": "Skrzynki magazynowe", "cena": 12.00, "opis": "Do rega≈Ç√≥w (G10868) warto dobraƒá organizery"}
}

DOMYSLNA_REKOMENDACJA = {"produkt": "Chemia warsztatowa / Zmywacze", "cena": 50.00, "opis": "Uniwersalny produkt, by dobiƒá do progu"}

# ==========================================
# üîß FUNKCJE SYSTEMOWE
# ==========================================

if 'historia' not in st.session_state:
    st.session_state['historia'] = []

def wyslij_maila(dane, rekomendacja, email_nadawcy, haslo_nadawcy, email_odbiorcy):
    msg = MIMEMultipart()
    msg['From'] = email_nadawcy
    msg['To'] = email_odbiorcy
    msg['Subject'] = f"üîî UPSELL: {dane['firma']} (Brakuje {dane['brakuje']:.2f} z≈Ç)"
    
    body = f"""
    RAPORT ASYSTENTA GEKO
    ===============================
    üë§ KLIENT: {dane['firma']}
    üìç ADRES: {dane['adres']}
    üìû NIP: {dane['nip']}
    ===============================
    üí∞ OBECNIE: {dane['netto']:.2f} z≈Ç
    üéØ CEL (1000 z≈Ç): Brakuje {dane['brakuje']:.2f} z≈Ç
    ===============================
    üí° REKOMENDACJA: {rekomendacja['produkt']}
    üìù ARGUMENT: {rekomendacja['opis']}
    """
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_nadawcy, haslo_nadawcy)
        server.sendmail(email_nadawcy, email_odbiorcy, msg.as_string())
        server.quit()
        return True
    except Exception:
        return False

def analizuj_pdf(uploaded_file):
    try:
        text = ""
        with pdfplumber.open(uploaded_file) as pdf:
            for page in pdf.pages:
                t = page.extract_text()
                if t: text += t
        return text
    except: return ""

def wyciagnij_dane_wstepne(text):
    # Kwota (szukanie max liczby)
    kwoty = re.findall(r"(\d+[\.,]\d{2})\s?PLN", text)
    if not kwoty: kwoty = re.findall(r"(\d+[\.,]\d{2})", text)
    netto = max([float(k.replace(',', '.').replace(' ', '')) for k in kwoty]) if kwoty else 0.0

    # NIP
    nipy = re.findall(r'\d{10}', text.replace('-', ''))
    nip = next((n for n in nipy if n != MOJ_NIP), "Brak NIP")

    # Firma
    firma = "Nieznana Firma"
    adres = "Brak adresu"
    if "Nabywca" in text:
        try:
            parts = text.split("Nabywca")
            if len(parts) > 1:
                lines = parts[1].strip().splitlines()
                if lines: firma = lines[0][:40]
                if len(lines) > 1 and "NIP" not in lines[1]: adres = lines[1][:50]
        except: pass
    return netto, nip, firma, adres

def znajdz_rekomendacje(text):
    for slowo, regula in INTELIGENTNE_REGULY.items():
        if slowo.lower() in text.lower(): return regula
    return DOMYSLNA_REKOMENDACJA

# ==========================================
# üì± INTERFEJS APLIKACJI
# ==========================================
st.set_page_config(page_title="GEKO Master", page_icon="üèÜ", layout="centered")

# Pobieranie hase≈Ç
try:
    EMAIL_NADAWCY = st.secrets["EMAIL_NADAWCY"]
    HASLO_NADAWCY = st.secrets["HASLO_NADAWCY"]
    EMAIL_ODBIORCY = st.secrets["EMAIL_ODBIORCY"]
except:
    EMAIL_NADAWCY = None

# --- MENU BOCZNE ---
with st.sidebar:
    st.header("‚öôÔ∏è Ustawienia")
    st.info(f"Pr√≥g: {PROG_KWOTOWY:.0f} z≈Ç")
    st.info(f"Limit interwencji: {LIMIT_INTERWENCJI:.0f} z≈Ç")
    st.markdown("---")
    st.markdown("**Aktywne Gazetki:**")
    st.caption("‚úÖ Stycze≈Ñ 2026")
    st.caption("‚úÖ Wielosztuki 2026AB")
    st.caption("‚úÖ Promocje Ilo≈õciowe")

# --- ZAK≈ÅADKI ---
tab1, tab2 = st.tabs(["üöÄ SKANER", "üìà WYNIKI"])

with tab1:
    st.title("GEKO Sales Booster üèÜ")
    uploaded_file = st.file_uploader("Wrzuƒá fakturƒô (PDF)", type="pdf")

    if uploaded_file:
        text = analizuj_pdf(uploaded_file)
        
        if text:
            # 1. Automatyczne czytanie
            netto_auto, nip, firma, adres = wyciagnij_dane_wstepne(text)
            
            st.markdown("---")
            # 2. SEKCJA KOREKTY (TO JEST NOWO≈öƒÜ!)
            # Pozwala Ci poprawiƒá kwotƒô, je≈õli automat siƒô pomyli≈Ç
            col_input1, col_input2 = st.columns([2, 1])
            with col_input1:
                st.subheader(f"Klient: {firma}")
                st.caption(f"NIP: {nip} | {adres}")
            with col_input2:
                netto_final = st.number_input("Sprawd≈∫ Kwotƒô Netto:", value=netto_auto, step=10.0, format="%.2f")
            
            # 3. Analiza po zatwierdzeniu/korekcie
            rekomendacja = znajdz_rekomendacje(text)
            brakuje = PROG_KWOTOWY - netto_final
            
            # Zapis do historii (unikamy dubli)
            unikalne_id = f"{firma}_{netto_final}"
            if not any(h['id'] == unikalne_id for h in st.session_state['historia']):
                 st.session_state['historia'].append({
                    "id": unikalne_id, "firma": firma, "netto": netto_final,
                    "status": "OK" if brakuje <= 0 else ("ALARM" if brakuje <= LIMIT_INTERWENCJI else "SKIP")
                })

            st.markdown("---")
            
            # 4. WIZUALIZACJA I DECYZJA
            postep = min(netto_final / PROG_KWOTOWY, 1.0)
            st.progress(postep, text=f"Postƒôp do nagrody: {int(postep*100)}%")
            
            if brakuje <= 0:
                st.balloons()
                st.success(f"‚úÖ BRAWO! Zam√≥wienie na {netto_final:.2f} z≈Ç. Pr√≥g zdobyty!")
            
            elif brakuje > LIMIT_INTERWENCJI:
                st.info(f"üîµ Brakuje {brakuje:.2f} z≈Ç. Powy≈ºej limitu {LIMIT_INTERWENCJI} z≈Ç. Nie dzwonimy.")
            
            else:
                # G≈Å√ìWNA SEKCJA UPSELLINGU
                st.error(f"üî• ALARM! Brakuje tylko {brakuje:.2f} z≈Ç")
                
                with st.container(border=True):
                    st.markdown(f"### üí° Proponuj: **{rekomendacja['produkt']}**")
                    st.markdown(f"*{rekomendacja['opis']}*")
                    st.markdown("---")
                    
                    # Gotowiec SMS
                    sms_text = f"Dzie≈Ñ dobry! Brakuje Panu tylko {brakuje:.0f} z≈Ç do darmowej bluzy polarowej w GEKO. Mo≈ºe dorzucimy {rekomendacja['produkt']}? Akurat pasuje do zam√≥wienia."
                    st.code(sms_text, language="text")
                    st.caption("üëÜ Skopiuj tre≈õƒá SMS-a")

                if st.button("üìß Wy≈õlij raport mailem"):
                    dane = {"firma": firma, "nip": nip, "adres": adres, "netto": netto_final, "brakuje": brakuje}
                    if EMAIL_NADAWCY:
                        if wyslij_maila(dane, rekomendacja, EMAIL_NADAWCY, HASLO_NADAWCY, EMAIL_ODBIORCY):
                            st.toast("Wys≈Çano!", icon="‚úÖ")
                        else: st.error("B≈ÇƒÖd wysy≈Çki.")
                    else: st.warning("Brak konfiguracji maila.")
        else:
            st.error("B≈ÇƒÖd odczytu PDF. Plik mo≈ºe byƒá uszkodzony.")

with tab2:
    st.header("üìä Statystyki Sesji")
    if st.session_state['historia']:
        df = pd.DataFrame(st.session_state['historia'])
        
        c1, c2, c3 = st.columns(3)
        c1.metric("Faktury", len(df))
        c2.metric("Obr√≥t", f"{df['netto'].sum():.2f} z≈Ç")
        c3.metric("Okazje (Alarm)", len(df[df['status']=='ALARM']), delta_color="inverse")
        
        # Wykres
        fig, ax = plt.subplots()
        colors = {'OK': '#28a745', 'ALARM': '#dc3545', 'SKIP': '#6c757d'}
        ax.bar(df['firma'], df['netto'], color=df['status'].map(colors))
        plt.xticks(rotation=45, ha='right')
        plt.title("Warto≈õƒá zam√≥wie≈Ñ")
        st.pyplot(fig)
        
        st.dataframe(df[['firma', 'netto', 'status']], hide_index=True)
        if st.button("Wyczy≈õƒá historiƒô"):
            st.session_state['historia'] = []
            st.rerun()
    else:
        st.info("Zeskanuj co≈õ, ≈ºeby zobaczyƒá wykresy.")